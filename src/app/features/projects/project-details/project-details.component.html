<section *ngIf="project$ | async as project; else loading" class="project-details">
  <header class="header">
    <h2>{{ project.name }}</h2>
    <a [routerLink]="['/projects', project.id, 'gantt']" class="btn-primary" title="Voir le Gantt">Gantt</a>
  </header>

  <div class="info">
    <div class="info-cards">
      <div class="info-card">
        <div class="title">Total tâches</div>
        <div class="value black">{{ (stats$ | async)?.total || 0 }}</div>
        <div class="icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="#f97316" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
          </svg>
        </div>
      </div>
      <div class="info-card">
        <div class="title">En progression</div>
        <div class="value blue">{{ (stats$ | async)?.inprogress || 0 }}</div>
        <div class="icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="#1d4ed8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M12 6v6l4 2"></path>
          </svg>
        </div>
      </div>
      <div class="info-card">
        <div class="title">Terminées</div>
        <div class="value green">{{ (stats$ | async)?.completed || 0 }}</div>
        <div class="icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="#047857" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20 6L9 17l-5-5"></path>
          </svg>
        </div>
      </div>
      <div class="info-card">
        <div class="title">Collaborateurs</div>
        <div class="value purple">{{ (members$ | async)?.length || 0 }}</div>
        <div class="icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="#6d28d9" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M17 21v-2a4 4 0 0 0-4-4H7a4 4 0 0 0-4 4v2"></path>
            <circle cx="9" cy="7" r="4"></circle>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
          </svg>
        </div>
      </div>
    </div>

    <div class="about">
      <div class="block">
        <div class="label">Description</div>
        <div class="text">{{ project.description || '—' }}</div>
      </div>
      <div class="block">
        <div class="label">Statut</div>
        <div class="badge">{{ statusLabel(project.status) }}</div>
      </div>
      <div class="block dates">
        <div>
          <div class="label">Début</div>
          <div class="text">{{ project.startDate | date:'mediumDate' }}</div>
        </div>
        <div>
          <div class="label">Fin</div>
          <div class="text">{{ project.endDate | date:'mediumDate' }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Membres du projet -->
  <section class="members">
    <h3>Membres</h3>
    <div class="member-grid" *ngIf="members$ | async as members">
      <div class="member-card" *ngFor="let u of members">
        <div class="avatar" [style.background]="colorFor(u.email || u.userName || '')">{{ (u.userName || u.email) | slice:0:2 | uppercase }}</div>
        <div class="info">
          <div class="name">{{ u.userName || u.email }}</div>
          <div class="email">{{ u.email }}</div>
          <div class="role">{{ project.createdBy === ('' + u.id) ? 'Manager' : 'Membre' }}</div>
        </div>
        <button *ngIf="project.createdBy === currentUserId" type="button" class="icon-btn danger" title="Retirer" aria-label="Retirer" (click)="removeMember(project, '' + u.id)">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <polyline points="3 6 5 6 21 6"/>
            <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/>
            <path d="M10 11v6M14 11v6"/>
            <path d="M9 6V4a2 2 0 0 1 2-2h2a 2 2 0 0 1 2 2v2"/>
          </svg>
        </button>
      </div>
    </div>
    <div *ngIf="project.createdBy === currentUserId" class="add-member">
      <input type="email" placeholder="Email utilisateur"
             [ngModel]="addMemberEmail" (ngModelChange)="onEmailChange($event)"
             (focus)="suggestionsVisible = true" (blur)="hideSuggestionsSoon()" />
      <ul class="suggestions" *ngIf="suggestionsVisible && (suggestions$ | async) as suggs">
        <li *ngFor="let s of suggs" (mousedown)="$event.preventDefault(); onSelectSuggestion(s)">
          {{ s.userName || s.email }} <small class="muted">{{ s.email }}</small>
        </li>
      </ul>
      <button type="button" (click)="addMember(project)">Ajouter</button>
    </div>
  </section>

  <!-- Jalons du projet -->
  <section class="milestones">
    <h3>Jalons</h3>
    <ul class="ml-list" *ngIf="milestones$ | async as milestones; else mlLoading">
      <li class="milestone" *ngFor="let ml of milestones">
        <div class="left">
          <label class="title">
            <input *ngIf="project.createdBy === currentUserId" class="ml-check" type="checkbox" [checked]="ml.isCompleted" (change)="toggleMilestone(ml)" />
            <span class="name">{{ ml.name }}</span>
          </label>
          <div class="meta">
            <span class="badge date">{{ ml.date | date:'mediumDate' }}</span>
            <span class="badge status" [class.done]="ml.isCompleted" [class.todo]="!ml.isCompleted">{{ ml.isCompleted ? 'Terminé' : 'À faire' }}</span>
          </div>
          <p class="desc" *ngIf="ml.description">{{ ml.description }}</p>
        </div>
        <div class="right">
          <button type="button" class="icon-btn danger" title="Supprimer" aria-label="Supprimer" *ngIf="project.createdBy === currentUserId" (click)="openConfirmMilestone(ml)">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <polyline points="3 6 5 6 21 6"/>
              <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/>
              <path d="M10 11v6M14 11v6"/>
              <path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/>
            </svg>
          </button>
        </div>
      </li>
    </ul>
    <ng-template #mlLoading>
      <p>Chargement des jalons...</p>
    </ng-template>

    <div *ngIf="project.createdBy === currentUserId" class="add-milestone">
      <input type="text" placeholder="Nom du jalon" [(ngModel)]="msName" />
      <input type="date" [(ngModel)]="msDate" [min]="today" />
      <input type="text" placeholder="Description (optionnel)" [(ngModel)]="msDescription" />
      <button type="button" class="btn-primary" (click)="createMilestone()" [disabled]="!msName || !msDate">
        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        Ajouter le jalon
      </button>
    </div>
  </section>

  <!-- Tâches du projet -->
  <section class="tasks-section">
    <app-task-list [projectId]="projectId" [managerId]="project.createdBy" [currentUserId]="currentUserId" [projectStatus]="project.status"></app-task-list>
  </section>
</section>
<ng-template #loading>
  <p>Chargement...</p>
</ng-template>

<!-- Toast notifications -->
<div class="toast-container" aria-live="polite" aria-atomic="true">
  <div
    class="toast"
    *ngFor="let t of toasts"
    [class.success]="t.type === 'success'"
    [class.error]="t.type === 'error'"
  >
    {{ t.message }}
    <button type="button" class="icon-close" (click)="closeToast(t.id)">×</button>
  </div>
</div>

<!-- Modale de confirmation de suppression de jalon (overlay global) -->
<div class="modal-backdrop" *ngIf="showConfirmMl" (click)="cancelConfirmMilestone()"></div>
<div class="modal" *ngIf="showConfirmMl" role="dialog" aria-modal="true">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Supprimer le jalon</h3>
      <button type="button" class="icon-close" aria-label="Fermer" (click)="cancelConfirmMilestone()">×</button>
    </div>
    <div class="modal-body">
      <p>Confirmer la suppression de ce jalon ? Cette action est définitive.</p>
      <div class="modal-actions">
        <button type="button" class="btn-secondary" (click)="cancelConfirmMilestone()">Annuler</button>
        <button type="button" class="btn-danger" (click)="confirmDeleteMilestone()">Supprimer</button>
      </div>
    </div>
  </div>
</div>
